<! DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/bootstrap-theme.min.css" rel="stylesheet">
    <script src="static/js/jquery-3.3.1.min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>

    <script src="static/js/vue.min.js"></script>
    <script type="text/javascript" src="static/js/csrf.js"></script>

    <!--<script src="static/js/home/home_modifyPassword.js"></script>无效-->
</head>

<body>
<!--登录成功后界面-->
<nav class="navbar navbar-default" role="navigation" id="navigation">
    <div class="navbar-header">
        <a class="navbar-brand" href="#"><i style="font-size:30px;color:deeppink">MyQ</i> {{user.name}}</a>
    </div>
    <div>
        <ul class="nav navbar-nav">
            <li class="active"><a href="#hall" data-toggle="tab">
                <span id="news_hall" style="background-color:orange" class="badge pull-right"></span>
                大厅&nbsp;</a></li>
            <li><a @click="init_contacts()" href="#contacts" data-toggle="tab">
                <span id="news_contacts" style="background-color:orange" class="badge pull-right"></span>
                联系人&nbsp;</a></li>
            <li><a @click="init_vote()" href="#vote" data-toggle="tab">
                投票&nbsp;</a></li>
            <!--<li><a href="#bottle" data-toggle="tab">
                <span id="news_bottle" style="background-color:orange" class="badge pull-right"></span>
                漂流瓶&nbsp;</a></li>-->
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">我的<b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a @click="init_base()" href="#modify_base" data-toggle="tab">修改资料</a></li>
                    <li><a href="#modify_password" data-toggle="tab">修改密码</a></li>
                    <li class="divider"></li>
                    <li><a @click="logout()">退 出</a></li>
                </ul>
            </li>

        </ul>
    </div>
    <div class="navbar-header">
        <a class="navbar-brand" href="#">等级: Lv{{user.level}}, 上次登录: {{user.login_time}}</a>
    </div>
</nav>
<!--上面为导航栏，下面为内容-->
<div class="tab-content">
    <div class="tab-pane fade in active" id="hall">
        {% include 'home_hall.html' %}
    </div>
    <div class="tab-pane fade" id="contacts">
        {% include 'home_contacts.html' %}
    </div>
    <div class="tab-pane fade" id="vote">
        {% include 'home_vote.html' %}
    </div>
    <div class="tab-pane fade" id="modify_base">
        {% include 'home_modifyBase.html' %}
    </div>
    <div class="tab-pane fade" id="modify_password">
        {% include 'home_modifyPassword.html' %}
    </div>
</div>

<!-- 模态框（Modal） 信息提示警告框-->
<div class="modal fade" id="myAlert" tabindex="-1" role="dialog" aria-labelledby="myAlertLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myAlertLabel">信息</h4>
            </div>
            <div class="modal-body" id="myAlertContent"></div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

</body>
</html>


<script type="text/javascript">

function emailVerify_recv()
{
    if($('#myEmailVerifyInput').val() == ""){
        $('#myEmailVerifyInput').focus();
    }
    else{
        $.post("/home/emailVerify_recv", 
            { 
                user_name: g_user_name,
                verify_code: $('#myEmailVerifyInput').val(),
            },
            function(data){     
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == "success"){
                    var hint = "邮箱绑定验证成功，请重新登录！";
                    $('#myEmailVerifyContent').html(hint);
                    ret_login = 1;
                }
                else if(obj.stat == "fail"){
                    var hint = obj.hint;
                    $('#myEmailVerifyContent').html(hint);
                }
            });
    }
}

function contact_add_row(obj, relation)
{
    if(relation == 1){      //陌生人
        var status_num = obj.status;

        if(status_num == 1)
            var color = "lightskyblue";
        else if(status_num == 2)
            var color = "aquamarine";
        else if(status_num == 0)
            var color = "lightsteelblue";
        else
        {}
        var tr = $("<tr class='tr_"+ obj.name +"' style='background-color:"+ color  +"'></tr>");

        tr.append('<td class="name">'+obj.name+'</td>');
        tr.append('<td class="nickname">'+obj.nickname+'</td>');
        var status_str = "";
        if(status_num == 0) status_str = "离线";
        else if(status_num == 1) status_str = "上线";
        else if(status_num == 2) status_str = "离开";
        else {}
        tr.append('<td class="status">'+ status_str +'</td>');
        var gender_num = obj.gender;
        var gender_str = "";
        if(gender_num == 1)gender_str = "男";
        else if(gender_num == 2)gender_str = "女";
        else if(gender_num == 3)gender_str = "保密";
        else {}
        tr.append('<td>'+ gender_str +'</td>');
        var handle = '<div class="dropdown">'
            + '<button type="button" class="btn btn-info" click_valid="valid" onclick="addFriend(event)">交友</button> ' 
            + '<button type="button" class="btn btn-info dropdown-toggle" id="dropdownMenuStrangerMove" data-toggle="dropdown">' 
            + '移 动<span class="caret"></span></button> '
            + '<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuStrangerMove">'
            + '<li role="presentation">'
                + '<a role="menuitem" style="cursor:pointer;" tabindex="-1" onclick="change_relation(event, 2)"">黑名单</a>'
            + '</li>'
            + '</ul>'
            + '<button type="button" class="btn btn-info" onclick="del_relation(event)">删除</button>'
            + '</div>';
        tr.append('<td>'+handle+'</td>');
        $('#id_contacts_stranger tbody').append(tr);
    }
    else if(relation == 0){         //好友
        var status_num = obj.status;

        if(status_num == 1)
            var color = "lightskyblue";
        else if(status_num == 2)
            var color = "aquamarine";
        else if(status_num == 0)
            var color = "lightsteelblue";
        else
        {}
        var tr = $("<tr class='tr_"+ obj.name +"' style='background-color:"+ color  +"'></tr>");

        tr.append('<td class="name">'+obj.name+'</td>');
        tr.append('<td class="nickname">'+obj.nickname+'</td>');
        
        var status_str = "";
        if(status_num == 0)
            status_str = "离线";
        else if(status_num == 1)
            status_str = "上线";
        else if(status_num == 2)
            status_str = "离开";
        tr.append('<td class="status">'+ status_str +'</td>');
        var gender_num = obj.gender;
        var gender_str = "";
        if(gender_num == 1)
            gender_str = "男";
        else if(gender_num == 2)
            gender_str = "女";
        else if(gender_num == 3)
            gender_str = "保密";
        tr.append('<td>'+ gender_str +'</td>');
        
        var sign_num = obj.sign;
        switch(sign_num)
        {
            case 0: sign_str = "保密";break;
            case 1: sign_str = "水瓶";break;
            case 2: sign_str = "双鱼";break;
            case 3: sign_str = "白羊";break;
            case 4: sign_str = "金牛";break;
            case 5: sign_str = "双子";break;
            case 6: sign_str = "巨蟹";break;
            case 7: sign_str = "狮子";break;
            case 8: sign_str = "处女";break;
            case 9: sign_str = "天秤";break;
            case 10: sign_str = "天蝎";break;
            case 11: sign_str = "射手";break;
            case 12: sign_str = "摩羯";break;
        }
        tr.append('<td>'+sign_str+'</td>');
        tr.append('<td>'+obj.email+'</td>');
        var handle = '<div class="dropdown">'
            + '<button type="button" class="btn btn-info" onclick="show_chat(event)"><span style="display:none;background-color:orange" class="chat_badge badge pull-right"></span>聊天</button> ';
        if(obj.name != "MyQ_jiantong"){ 
            handle += '<button type="button" class="btn btn-info dropdown-toggle" id="dropdownMenuFriendMove" data-toggle="dropdown">' 
            + '移 动<span class="caret"></span></button> '
            + '<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuFriendMove">'
            + '<li role="presentation">'
                +'<a role="menuitem" style="cursor:pointer;" tabindex="-1" onclick="change_relation(event, 1)">陌生人</a>'
            + '</li>'
            + '<li role="presentation">'
                + '<a role="menuitem" style="cursor:pointer;" tabindex="-1" onclick="change_relation(event, 2)">黑名单</a>'
            + '</li>'
            + '</ul>'
            + '<button type="button" class="btn btn-info" onclick="del_relation(event)">删除</button>';
        }
            // + '</div>';
        handle += '</div>';
        tr.append('<td>'+handle+'</td>');
        $('#id_contacts_friend tbody').append(tr);
    }
    else if(relation == 2){         //黑名单
        var tr = $("<tr></tr>");
        tr.append('<td class="name">'+obj.name+'</td>');
        var handle = '<div>'
            + '<button type="button" class="btn btn-info" click_valid="valid" onclick="compromise(event)">和解</button> ' 
            + '</div>';
        tr.append('<td>'+handle+'</td>');
        $('#id_contacts_blacklist tbody').append(tr);
    }
    else
    {}
}

function change_relation(event, relation)
{
    obj = event.currentTarget;
    name = $(obj).closest("tr").find("td.name").html();
    // alert("change " + name);

    g_guest_username = name;
    g_obj_will = obj;               //先将对象通过全局变量保存
    $.post("changeRelation", 
        {
            host: g_user_name,
            guest: name, 
            relation: relation,
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                //原关系的解除
                if(g_arry_contacts[g_guest_username].relation == 0){
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_friend_alive -= 1;
                    vue_contacts.count_friend -= 1;
                }
                else if(g_arry_contacts[g_guest_username].relation == 1){
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_stranger_alive -= 1;
                    vue_contacts.count_stranger -= 1;
                }
                else
                {}

                //新关系的生成
                if(obj.relation == 1){      //形同陌路
                    g_arry_contacts[g_guest_username].relation = 1;
                    contact_add_row(g_arry_contacts[g_guest_username], 1);
                    
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_stranger_alive += 1;
                    vue_contacts.count_stranger += 1;

                }
                else if(obj.relation == 2){   //黑名单
                    g_arry_contacts[g_guest_username].relation = 2;
                    contact_add_row(g_arry_contacts[g_guest_username], 2);
                    vue_contacts.count_blacklist += 1;
                }
                else
                {}

                $(g_obj_will).closest('tr').remove();
            }
            else{
                alert("something error@changeRelation back");
            }
        });
}

function del_relation(event)
{
    obj = event.currentTarget;
    name = $(obj).closest("tr").find("td.name").html();
    // alert("remove " + name);

    g_guest_username = name;
    g_obj_will = obj;               //先将对象通过全局变量保存
    $.post("delRelation", 
        {
            host: g_user_name,
            guest: name, 
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                if(g_arry_contacts[g_guest_username].relation == 0){
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_friend_alive -= 1;
                    vue_contacts.count_friend = vue_contacts.count_friend -1;
                }
                else if(g_arry_contacts[g_guest_username].relation == 1){
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_stranger_alive -= 1;
                    vue_contacts.count_stranger = vue_contacts.count_stranger -1;
                }
                else
                {}

                delete g_arry_contacts[g_guest_username];   //删除变量
                $(g_obj_will).closest('tr').remove();
            }
            else{
                alert("something error@delRelation back");
            }
        });
}

function compromise(event)
{
    obj = event.currentTarget;
    if($(obj).attr("click_valid") != "valid")
        return;

    var dst_username = $(obj).closest("tr").find("td.name").html();

    // alert("compromise");
    $(obj).html("正在发送");
    g_obj_will = obj;
    $.post("compromise", 
        {
            src: g_user_name,
            dst: dst_username, 
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                $(g_obj_will).html("已发送").attr("click_valid", "invalid");
            }
            else{
                alert("something error@compromise back");
            }
        });
}

function addFriend(event)
{
    obj = event.currentTarget;
    // if($(obj).html() != '交友')
    //     return;  这个注释暂时保留，提醒自己不要根据按钮显示的值作为判断依据，而要用属性
    if($(obj).attr("click_valid") != 'valid')
        return;

    var dst_username = $(obj).closest("tr").find("td.name").html();

    $(obj).html("正在发送");
    g_obj_will = obj;               //先将对象通过全局变量保存
    g_guest_username = dst_username;
    $.post("addFriendApply", 
        {
            src: g_user_name,
            dst: dst_username, 
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                if(obj.resp == 'ok'){
                    // var name = $(g_obj_will).closest('tr').find("td.name").html();
                    // $(g_obj_will).closest('td').empty().html("已加为好友");
                    
                    //原关系的解除
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_stranger_alive -= 1;
                    vue_contacts.count_stranger -= 1;
                    $(g_obj_will).closest('tr').remove();

                    //新关系的生成
                    contact_add_row(obj, 0);
                    if(g_arry_contacts[g_guest_username].status != 0)
                        vue_contacts.count_friend_alive += 1;
                    vue_contacts.count_friend += 1;
                    g_arry_contacts[g_guest_username].relation = 0;

                }
                else{     //wait
                    $(g_obj_will).html("已发送");
                    $(obj).attr("click_valid", "invalid");
                }
            }
            else{
                alert("something error@addFriendApply back");
            }
        });

}

function handle_news(event, handle)
{
    obj = event.currentTarget;
    id = $(obj).closest("tr").attr("id");

    if(handle == 'delete'){
        // alert(id);
        g_obj_will = $(obj).closest("tr");
        $.post("deleteNew", 
        {
            user_name: g_user_name,
            id: id, 
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                $(g_obj_will).remove();
            }
            else{
                alert("something error@deleteNew back");
            }
        });

    }
    else if(handle == 'agree' || handle == 'reject'){
        action_old = $(obj).closest("tr").find("td.action").attr("action");
        guest = $(obj).closest("tr").find("td.name").html();

        var action_new = 0;

        // alert(action_old);
        // alert(guest);
        if(action_old == 0){
            if(handle == 'agree') action_new = 1;
            else action_new = 2;
        }
        else if(action_old == 5){
            if(handle == 'agree') action_new = 6;
            else action_new = 7;
        }
        else
        {}

        // alert("response " + action_new);

        g_obj_will = obj;
        $.post("responseNew", 
        {
            user_name: g_user_name,
            guest: guest,
            id: id, 
            response: action_new,
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                var handle = $(g_obj_will).attr("handle");
                // alert(handle);

                if(handle == "agree"){
                     g_obj_contacts.cur_status = 'nothing';  //重新刷新联系人表格
                    $(g_obj_will).closest("tr").find("td.status").html("同意");
                }
                else if(handle == 'reject'){
                    $(g_obj_will).closest("tr").find("td.status").html("拒绝");
                }
                else
                {}
                $(g_obj_will).closest("td").find("button.response").remove();
            }
            else{
                alert("something error@responseNew back");
            }
        });


    }
    else{

    }


}

function addFriend_bySearch(event)
{
    obj = event.currentTarget;
    var dst_username = $(obj).closest("tr").find("td.name").html();

    $(obj).html("正在发送");

    g_obj_will = obj;               //先将对象通过全局变量保存
    g_guest_username = dst_username;
    $.post("addFriendApply", 
        {
            src: g_user_name,
            dst: dst_username, 
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                g_obj_contacts.cur_status = 'nothing';  //重新刷新联系人表格
                if(obj.resp == 'ok'){
                    // var name = $(g_obj_will).closest('tr').find("td.name").html();
                    $(g_obj_will).closest('td').empty().html("已加为好友");
                    
                    g_arry_contacts[g_guest_username] = new Object();
                    g_arry_contacts[g_guest_username].relation = 0;

                }
                else{     //wait
                    // var name = $(g_obj_will).closest('tr').find("td.name").html(); 
                    $(g_obj_will).closest('td').empty().html("已发送,等待对方通过");
                                       
                    g_arry_contacts[g_guest_username] = new Object();
                    g_arry_contacts[g_guest_username].relation = 1;

                }
            }
            else{
                alert("something error@news back");
            }
        });
}

function refresh_news_badge()       //刷新表示新消息的徽章badge
{
    if(g_news.new_contacts_base > 0)
        $('#news_base').show().html(g_news.new_contacts_base);
    else
        $('#news_base').hide();

    if(g_news.new_contacts > 0)
        $('#news_contacts').show().html(g_news.new_contacts);
    else
        $('#news_contacts').hide();
}

function change_calendar(cmd)
{
    if(cmd == 'now'){
        getCalendar()
    }
    else if(cmd == 'prev'){
        if(g_calendar.year > 1970 || (g_calendar.year == 1970) && (g_calendar.month > 1) )
        {
            if(g_calendar.month > 1){
                month = Number(g_calendar.month) - 1;
                year = g_calendar.year;
            }
            else{
                year = Number(g_calendar.year) - 1;
                month = 12;
            }
            
            getCalendar_assign(year, month);
        }
        
    }
    else if(cmd == 'next'){
        if(g_calendar.year < 2100){
            if(g_calendar.month < 12){
                year = g_calendar.year;
                month = Number(g_calendar.month) + 1;
            }
            else{
                year = Number(g_calendar.year) + 1;
                month = 1;
            }
        }

        getCalendar_assign(year, month);
    }
}

function getCalendar_assign(year, month)
{
    $.post("getCalendar", 
    {
        user_name: g_user_name,
        type: 1,    //0表示获取当月的日历，1表示指定年月的日历
        year: year,
        month: month,
    },
    function(data){
        // alert(data);    //约定格式....asdf
        var obj = JSON.parse(data);
        if(obj.stat == 'success')
        {
            cal_rows = obj.cal_table.split("\n");
            $('#calendar_head').html(obj.year+"年"+obj.month+"月");
            g_calendar.year = obj.year;
            g_calendar.month = obj.month;

            $('#calendar_body').empty();
            var body = "";
            if(cal_rows.length > 2){
                body = "<div>一&nbsp;&nbsp;&nbsp;二&nbsp;&nbsp;&nbsp;三&nbsp;&nbsp;&nbsp;四&nbsp;&nbsp;&nbsp;五&nbsp;&nbsp;&nbsp;六&nbsp;&nbsp;&nbsp;日</div>";
                $('#calendar_body').append(body);

                for(var i=2;i<(cal_rows.length-1);i++)
                {
                    days = $.trim(cal_rows[i]).split(/\s+/);
                    if(i == 2){     //第一行，
                        body = "<div>";
                        for(var j=0;j<(7-days.length);j++)
                            body += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                        for(var j=0;j<days.length;j++)
                            body += "&nbsp;&nbsp;&nbsp;" + days[j] + "&nbsp;";
                        body += "</div>";
                        $('#calendar_body').append(body);
                    }
                    else{
                        body = "<div>";
                        for(var j=0;j<days.length;j++){
                            if(days[j].length == 1)
                                body += "&nbsp;&nbsp;&nbsp;" + days[j] + "&nbsp;";
                            else
                                body += "&nbsp;" + days[j] + "&nbsp;";
                        }
                        body += "</div>";
                        $('#calendar_body').append(body);
                    }
                }
            }

        }
        else{
            alert("something error@getCalendar back");
        }
    });
}

function getCalendar()
{
    $.post("getCalendar", 
    {
        user_name: g_user_name,
        type: 0,    //0表示获取当月的日历，1表示指定年月的日历
    },
    function(data){
        // alert(data);    //约定格式....asdf
        var obj = JSON.parse(data);
        if(obj.stat == 'success')
        {
            cal_rows = obj.cal_table.split("\n");
            $('#calendar_head').html(obj.year+"年"+obj.month+"月");
            g_calendar.year = obj.year;
            g_calendar.month = obj.month;
            today = obj.day

            $('#calendar_body').empty();
            var body = "";
            if(cal_rows.length > 2){
                body = "<div>一&nbsp;&nbsp;&nbsp;二&nbsp;&nbsp;&nbsp;三&nbsp;&nbsp;&nbsp;四&nbsp;&nbsp;&nbsp;五&nbsp;&nbsp;&nbsp;六&nbsp;&nbsp;&nbsp;日</div>";
                $('#calendar_body').append(body);

                for(var i=2;i<(cal_rows.length-1);i++)
                {
                    days = $.trim(cal_rows[i]).split(/\s+/);
                    if(i == 2){     //第一行，
                        body = "<div>";
                        for(var j=0;j<(7-days.length);j++)
                            body += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                        for(var j=0;j<days.length;j++){
                            if(days[j] == today)
                                body += "&nbsp;&nbsp;&nbsp;<font color='red'>" + days[j] + "</font>&nbsp;";
                            else
                                body += "&nbsp;&nbsp;&nbsp;" + days[j] + "&nbsp;";
                        }
                        body += "</div>";
                        $('#calendar_body').append(body);
                    }
                    else{
                        body = "<div>";
                        for(var j=0;j<days.length;j++){
                            if(days[j].length == 1){
                                if(days[j] == today)
                                    body += "&nbsp;&nbsp;&nbsp;<font color='red'>" + days[j] + "</font>&nbsp;";
                                else
                                    body += "&nbsp;&nbsp;&nbsp;" + days[j] + "&nbsp;";
                            }
                            else{
                                if(days[j] == today)
                                    body += "&nbsp;<font color='red'>" + days[j] + "</font>&nbsp;";
                                else
                                    body += "&nbsp;" + days[j] + "&nbsp;";
                            }
                        }
                        body += "</div>";
                        $('#calendar_body').append(body);
                    }
                }
            }

        }
        else{
            alert("something error@getCalendar back");
        }
    });
}

function test_post()
{   
    $.post("testpost", 
        {
            host: g_user_name,
        },
        function(data){
            // alert(data);    //约定格式....
            
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                for(i=0;i<obj.days.length;i++)
                {
                    $('#weather_body_'+i).find('div.weather_date').html(obj.days[i][0]);
                    $('#weather_body_'+i).find('div.weather_desc').html(obj.days[i][1]);
                    if(obj.days[i][2])
                        $('#weather_body_'+i).find('div.weather_temp').html(obj.days[i][3] + " ~ " + obj.days[i][2] + "度");
                    else
                        $('#weather_body_'+i).find('div.weather_temp').html(obj.days[i][3]  + "度");
                }
            }
            else{
                alert("something error@testpost back");
            }
        });
}

var g_user_name = '{{user.name}}';      //记得加引号哦
var ret_login = 0;

var g_calendar = 
{
    year: 0,
    month: 0,
}

var g_weather = 
{
    city: 'A',

}

var g_obj_contacts =        //联系人相关标志
{
    cur_status: 'nothing',  //取值'nothing', 'ready','friend', 'stranger', 'blacklist'
}

var g_obj_will = "";        //中介
var g_guest_username;       //中介

var g_arry_contacts = [];

var g_news = 
{
    new_contacts: '{{user.news_contacts}}',             //新消息，所有联系人消息，包括聊天
    new_contacts_base: '{{user.news_contacts_base}}',   //新消息，联系人基本信息
    new_contacts_chat: 0,   //新消息，聊天, 初始值为0，让定时器周期性地去获取
    // new_contacts_status: 0, 暂时不需要
    inform_handle: null     //通知框相关的处理句柄
}

var g_chat = 
{
    current_guest: '',          //当前聊天的对象
    new_chat_flag: 0,           //新消息的字样只显示一次
    // message: '',        
    timestamp_1_sec: -3600,     //上一条显示了时间的信息的时间戳(秒)
    timestamp_1_day: '',    //上一条显示了时间的信息的'年月日'
    timestamp_2_sec: -3600,     //上一条信息的时间戳(秒)
}

var g_heart =     
{
    handle: null,         //句柄
    heart_cycle: 5,       //5秒执行一次，在聊天时可以缩短为2秒
    heart_cycle_fast: 2,    //适合实时聊天
    //修改策略，不使用下面两个变量
    // quiet_keep_max: (10*60)/5,     //10分钟保持安静，就停止发心跳
    // quiet_keep_cnt: (10*60)/5,     //每次心跳减1

}

var g_obj_user =            //用户基本信息
{
    read_flag: 0,           //初始化标志, 用户基本资料
    nickname: "",           
    email: "",
    emailValid: 0,
    sign: 0,
    gender: 0,
    
    status: 1,          //默认就是上线啦
    status_will: 0,
    permitAdd: '{{user.permitAdd}}',
    permitSearch: '{{user.permitSearch}}',
    permitAdd_will: 0,
    permitSearch_will: 0,
}

var g_vote = 
{
    id: 0,

}

function weather_get_byCity(city)
{
    var city_num = '';

    switch(city) 
    {
        case 'A': city_num = '101210101';
            break;
        case 'B': city_num = '101210401'; 
            break;
        case 'C':city_num = '101210701'; 
            break;
        case 'D':city_num = '101210501'; 
            break;
        case 'E':city_num = '101210201'; 
            break;
        case 'F':city_num = '101210301'; 
            break;
        case 'G':city_num = '101210901'; 
            break;
        case 'H':city_num = '101211001'; 
            break;
        case 'J':city_num = '101210601'; 
            break;
        case 'K':city_num = '101210801'; 
            break;
        case 'L':city_num = '101211101'; 
            break;
        default: break;
    }

    url_weather = 'http://www.weather.com.cn/weather/'+ city_num +'.shtml';

    $('.weather_body').hide();
    $('.weather_hint').show();

    $.post("getWeather", 
        {
            user_name: g_user_name,
            url: url_weather
        },
        function(data){
            // alert(data);    //约定格式....
            
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                $('.weather_hint').hide();
                for(i=0;i<obj.days.length;i++)
                {
                    $('#weather_body_'+i).find('div.weather_date').html(obj.days[i][0]);
                    $('#weather_body_'+i).find('div.weather_desc').html(obj.days[i][1]);
                    if(obj.days[i][2])
                        $('#weather_body_'+i).find('div.weather_temp').html(obj.days[i][3] + " ~ " + obj.days[i][2] + "度");
                    else
                        $('#weather_body_'+i).find('div.weather_temp').html(obj.days[i][3]  + "度");

                    $('#weather_body_'+i).show();
                }
            }
            else{
                alert("something error@testpost back");
            }
        });
}

function weather_get(event)
{
    obj = event.currentTarget;
    city = $(obj).val();
    if(city == g_weather.city)
        return;

    g_weather.city = city;

    weather_get_byCity(city);
}

function show_chat(event)
{
    obj = event.currentTarget;

    $(obj).find("span").html("").hide();
    
    var nickname = $(obj).closest("tr").find("td.nickname").html();
    vue_contacts.chat_object = nickname;
    var guest = $(obj).closest("tr").find("td.name").html();
    g_chat.current_guest = guest;      //记下当前聊天中的用户名
    g_chat.new_chat_flag = 0;
    $('#chatDisplay').html("");  
    $('#chatSend').val("");
    $.post("readChats", 
        {
            host: g_user_name,
            guest: guest
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == 'success')
            {
                var msg_old = "";
                var time_tmp = '';
                var day_tmp = '';
                var sec_tmp = 0;

                for(var i=0;i<obj.count;i++){

                    if(g_chat.new_chat_flag == 0 && obj.chats[i].io == 1 && obj.chats[i].in_status == 0){
                        g_chat.new_chat_flag = 1;
                        msg_old += "<div style='text-align:center'><span style='color: deeppink'>* 新消息 *</span></div>";
                    }

                    time_tmp = obj.chats[i].time;
                    var arry = time_tmp.split(" ");
                    day_tmp = arry[0];      //年-月-日
                    var arry_2 = arry[1].split(":");
                    sec_tmp = arry_2[0]*3600 + arry_2[1]*60 + arry_2[2];    //当天秒数

                    if(day_tmp != g_chat.timestamp_1_day || ((sec_tmp-g_chat.timestamp_1_sec) > 60*5)
                        || ((sec_tmp-g_chat.timestamp_2_sec) > (60*2)) ){
                        //不在同一天，或者消息比显示了时间的消息多了5分钟，或者比上一条消息多了2分钟
                        g_chat.timestamp_1_day = day_tmp;
                        g_chat.timestamp_1_sec = sec_tmp;
                        g_chat.timestamp_2_sec = sec_tmp;
                        msg_old += "<div style='text-align:center'><span style='color: deeppink'>* "+ time_tmp +" *</span></div>";
                    }
                    else{
                        g_chat.timestamp_2_sec = sec_tmp;
                    }

                    var message = obj.chats[i].message;
                    if(obj.chats[i].type == 1)
                        message = "【自动回复】您好，我现在有事不在，一会再和您联系！";


                    if(obj.chats[i].io == 0){     
                        msg_old += "<div><我> "+ message + "</div>";
                    }
                    else if(obj.chats[i].io == 1){
                        msg_old += "<div style='text-align:right; color:blue'>" + message + " &lt;"+ g_chat.current_guest +"&gt;</div>";
                    }
                    else
                    {}      //nothing
                }

                $('#chatDisplay').append(msg_old);
                $('#chat_window').modal("show");
            }
            else{
                alert("something error@readChats back");
            }
        });
}

/*************************************************************************
//检查是否有新消息
1. 浏览器定期以post消息向web服务器后台查询news(同时作为心跳机制)
2. 若浏览器页面被关掉或者用户长时间未操作页面(未点击按钮)，则和web服务器之间的心跳停了
3. 浏览器维护一个计数器，初始值为N，每次发心跳之后，该计数值减1，当用户有操作页面时，将该数置为N，当数值为0时，停止发心跳，
   现在为假死状态，若在web服务器认为超时之前，用户点击了页面按钮，就算复活了
4. web服务器也维护一个计数器，初始值为N，mysql定时事件每次减去1，来自浏览器的心跳又将该值变为N，当该值为0时，认为超时，设置用户的状态为离线
5. 若超时之后，浏览器再往后台发送post，则后台应该返回相应的错误，浏览器得到错误后应该给出提示后返回登录界面

**************************************************************************/
function check_news()
{
    // if(g_heart.quiet_keep_cnt > 0){
    //     g_heart.quiet_keep_cnt -= 1;
    $.post("check_news", 
        { user_name: g_user_name},
        function(data){     
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            if(obj.stat == "success"){
                if((obj.news_contacts != g_news.new_contacts) || (obj.news_contacts_base != g_news.new_contacts_base)){
                    g_news.new_contacts = obj.news_contacts;
                    g_news.new_contacts_base = obj.news_contacts_base;
                    // if(g_user_name == "asdfasdf")
                    //     alert(g_news.new_contacts + " " + g_news.new_contacts_base);
                    refresh_news_badge();       //刷新徽章
                }

                if(obj.news_contacts_status > 0){   //发现有状态变化

                    $.post("check_status",
                        {user_name: g_user_name},
                        function(data){
                            // alert(data);
                            var obj = JSON.parse(data);
                            if(obj.stat == "success"){
                                if(obj.cnt > 0){
                                    if(!g_news.inform_handle)   //说明需要重新显示新通知
                                        $('#inform_text').empty();

                                    for(var i=0;i<obj.cnt;i++){
                                        var name = obj.status_list[i].name;
                                        var status = obj.status_list[i].status;
                                        var status_str = "";
                                        var color = "";
                                        switch(status)
                                        {
                                            case 0:
                                                status_str = "离线";
                                                color = "lightsteelblue";
                                                break;
                                            case 1:
                                                status_str = "上线";
                                                color = "lightskyblue";
                                                break;
                                            case 2:
                                                status_str = "离开";
                                                color = "aquamarine";
                                                break;
                                        }
                                        var alert_info = "用户"+name+status_str+"了!<br />"
                                        $('#inform_text').append(alert_info);

                                        $('tr.tr_'+name).find('td.status').html(status_str);
                                        $('tr.tr_'+name).css("background-color", color);
                                    }

                                    if(!g_news.inform_handle){
                                        $('#inform_div').fadeIn("fast");
                                        g_news.inform_handle = setTimeout(function(){
                                                g_news.inform_handle = null;
                                                $('#inform_div').fadeOut(1500);
                                            }, 3500);
                                    }
                                    else{   //说明之前的通知框还存在，又来了新消息
                                        clearTimeout(g_news.inform_handle);
                                        g_news.inform_handle = setTimeout(function(){
                                                g_news.inform_handle = null;
                                                $('#inform_div').fadeOut(1500);
                                            }, 3500);
                                    }
                                    
                                }
                            }
                            else if(obj.stat == "fail"){
                                alert("something error@check_status back");
                            }
                    });
                    
                }

                if(obj.news_contacts_chat != g_news.new_contacts_chat){     //发现有聊天信息
                    g_news.new_contacts_chat = obj.news_contacts_chat;

                    if(g_news.new_contacts_chat > 0)
                        $('#friend_chats').show().html(g_news.new_contacts_chat);
                    else
                        $('#friend_chats').hide();
                    //这时候需要发送查询命令到后台，查询是哪些用户发来了新消息
                    $.post("check_chats",
                        {user_name: g_user_name},
                        function(data){
                            // alert(data);
                            var obj = JSON.parse(data);
                            if(obj.stat == "success"){
                                if(obj.cnt_users > 0){
                                    for(var i=0;i<obj.cnt_users;i++){
                                        var name = obj.chats_list[i].name;
                                        var cnt = obj.chats_list[i].cnt;

                                        if((g_chat.current_guest != "") && (g_chat.current_guest == name)){
                                            $.post("read_newChat",
                                                {
                                                    host: g_user_name,
                                                    guest: name
                                                },
                                                function(data){
                                                    // alert(data);
                                                    var obj = JSON.parse(data);
                                                    if(obj.stat == "success"){

                                                        var msg_old = "";
                                                        var time_tmp = '';
                                                        var day_tmp = '';
                                                        var sec_tmp = 0;

                                                        for(var i=0;i<obj.count;i++){
                                                            if(g_chat.new_chat_flag == 0){
                                                                g_chat.new_chat_flag = 1;
                                                                msg_old += "<div style='text-align:center'><span style='color: deeppink'>* 新消息 *</span></div>"
                                                            }

                                                            time_tmp = obj.chats[i].time;
                                                            var arry = time_tmp.split(" ");
                                                            day_tmp = arry[0];      //年-月-日
                                                            var arry_2 = arry[1].split(":");
                                                            sec_tmp = arry_2[0]*3600 + arry_2[1]*60 + arry_2[2];    //当天秒数
                                                            if(day_tmp != g_chat.timestamp_1_day || ((sec_tmp-g_chat.timestamp_1_sec) > 60*5)
                                                                || ((sec_tmp-g_chat.timestamp_2_sec) > (60*2)) ){
                                                                //不在同一天，或者消息比显示了时间的消息多了5分钟，或者比上一条消息多了2分钟
                                                                g_chat.timestamp_1_day = day_tmp;
                                                                g_chat.timestamp_1_sec = sec_tmp;
                                                                g_chat.timestamp_2_sec = sec_tmp;
                                                                msg_old += "<div style='text-align:center'><span style='color: deeppink'>* "+ time_tmp +" *</span></div>";
                                                            }
                                                            else{
                                                                g_chat.timestamp_2_sec = sec_tmp;
                                                            }

                                                            var message = obj.chats[i].message;
                                                            if(obj.chats[i].type == 1)
                                                                message = "【自动回复】您好，我现在有事不在，一会再和您联系！";

                                                            msg_old += "<div style='text-align:right; color:blue'>" + message + " &lt;"+ g_chat.current_guest +"&gt;</div>"

                                                            $('#chatDisplay').append(msg_old);
                                                            $('#chatDisplay').append("<input type='button' value='***' />");
                                                            $('#chatDisplay').find('input:last-child').focus().remove();
                                                        }

                                                    }
                                                    else if(obj.stat == "fail"){
                                                        alert("something error@read_newChat back");
                                                    }
                                            });
                                            
                                        }
                                        else{
                                            var old = $('#id_contacts_friend').find("tr.tr_"+name).find("span.chat_badge").html();
                                            if(old == "") old = 0;
                                            $('#id_contacts_friend').find("tr.tr_"+name).find("span.chat_badge").show().html(cnt);
                                            if(old != cnt){
                                                var diff = cnt - old;
                                                var alert_info = "用户"+name+"发来"+diff+"条新消息!<br />"

                                                if(!g_news.inform_handle)   //说明需要重新显示新通知
                                                    $('#inform_text').empty();
                                                $('#inform_text').append(alert_info);

                                                if(!g_news.inform_handle){
                                                    $('#inform_div').fadeIn("fast");
                                                    g_news.inform_handle = setTimeout(function(){
                                                            g_news.inform_handle = null;
                                                            $('#inform_div').fadeOut(1500);
                                                        }, 3500);
                                                }
                                                else{   //说明之前的通知框还存在，又来了新消息
                                                    clearTimeout(g_news.inform_handle);
                                                    g_news.inform_handle = setTimeout(function(){
                                                            g_news.inform_handle = null;
                                                            $('#inform_div').fadeOut(1500);
                                                        }, 3500);
                                                }
                                                
                                            }
                                        }
                                        
                                    }
                                }
                            }
                            else if(obj.stat == "fail"){
                                alert("something error@check_chats back");
                            }

                        });
                }
            }
            else if(obj.stat == "fail"){
                if(obj.reason == 'SESSION_INVALID'){
                    clearInterval(g_heart.handle);
                    alert("因为您长时间没有操作页面或者有非法操作，请重新登录^_^");
                    window.location.href = "login";
                }
                else
                    alert("something error@check_news back");
            }

        });
    // }
}

function history_today()
{

    $('#today_history_hint').show();
    $('#today_history_content').hide();

    $('#today_history').modal('show');

    $.post("getHistory", 
        {
            user_name: g_user_name,
        },
        function(data){
            // alert(data);    //约定格式....
            var obj = JSON.parse(data);
            // alert(obj.history.length);
            if(obj.stat == 'success')
            {
                $('#today_history_hint').hide();
                $('#today_history_content').empty();
                var txt = "";
                for(var i=0;i<obj.history.length;i++)
                {
                    txt += obj.history[i].date + "  " + obj.history[i].incident + "<br />";
                }

                $('#today_history_content').append(txt);
                $('#today_history_content').show();
            }
            else{
                alert("something error@getHistory back");
            }
        });
}

$(function () {         //页面加载事件

    refresh_news_badge();
    g_heart.handle = setInterval(check_news, g_heart.heart_cycle*1000);    

    getCalendar();
    weather_get_byCity(g_weather.city);

    //---------------------------------------------------
    $('#myEmailVerify').on('show.bs.modal', function () {
        var hint = "请稍后，正在发送邮件...";
        $('#myEmailVerifyContent').html(hint);

        $.post("/home/emailVerify_send", 
            { user_name: g_user_name},
            function(data){     
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == "success"){
                    var hint = "已往您的邮箱"+ g_obj_user.email +"发送验证码，请登陆邮箱查看，并在此：" + 
                        "<input type='text' class='form-control' id='myEmailVerifyInput' placeholder='输入验证码'></input><br />" +
                        "<button type='button' onclick='emailVerify_recv()' class='btn btn-primary btn-block'>确 定</button>";

                    $('#myEmailVerifyContent').html(hint);
                }
                else if(obj.stat == "fail"){
                    var hint = obj.hint;
                    $('#myEmailVerifyContent').html(hint);
                }
            });
    })

    $('#myAlert').on('hidden.bs.modal', function () {
        if(ret_login == 1){     //密码修改成功，跳转到登陆页面
            window.location.href = "login";
        }
    })
    $('#myEmailVerify').on('hidden.bs.modal', function () {
        if(ret_login == 1){     //跳转到登陆页面
            window.location.href = "login";
        }
    })

    $('#add_friends').on('hidden.bs.modal', function () {
        vue_nav.init_contacts();
    })

    $('#contacts_news').on('hidden.bs.modal', function () {
        vue_nav.init_contacts();
    })

    $('#chat_window').on('hidden.bs.modal', function () {
        g_chat.current_guest = "";  //不为空则说明有聊天窗口在打开状态
        g_chat.new_chat_flag = 0;
        g_chat.timestamp_1_day = '';
        g_chat.timestamp_1_sec = -3600;
        g_chat.timestamp_2_sec = -3600;
    })

    $('#chat_window').on('shown.bs.modal', function () {
        $('#chatDisplay').append("<input type='button' value='***' />");
        $('#chatDisplay').find('input:last-child').focus().remove();
    })

    $('#chatSend').bind('keypress', function(event){
        if(event.keyCode == '13')
		{
            vue_contacts.chatSend();
        }
    })
});

var vue_nav = new Vue({
    delimiters:['[[', ']]'],
    el: '#navigation',
    data: {
    },
    methods:{
        logout:function(){
            $.post("logout", 
            {user_name: g_user_name},
            function(data){
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == 'success')
                   window.location.href = 'login';
            });
        },

        init_base:function(){
            if(g_obj_user.read_flag == 0){               //为0表示还没有向后台读取过数据
                $.post("/home/readBase", 
                    { user_name: g_user_name},
                    function(data){     
                        // alert(data);    //约定格式....
                        var obj = JSON.parse(data);
                        if(obj.stat == "success"){
                            g_obj_user.nickname = obj.user_nickname;
                            g_obj_user.email = obj.user_email;
                            g_obj_user.sign = obj.user_sign;
                            g_obj_user.gender = obj.user_gender;
                            g_obj_user.emailValid = obj.user_emailValid;

                            // g_obj_user.status = obj.user_status;
                            // g_obj_user.permitAdd = obj.setting_permitAdd;
                            // g_obj_user.permitSearch = obj.setting_permitSearch;
                            $('#user_registertime').html(obj.register_time);
                            $('#user_nickname').val(g_obj_user.nickname);
                            $('#user_email').val(g_obj_user.email);
                            $('#user_sign').val(g_obj_user.sign);
                            $('#user_gender_'+g_obj_user.gender).prop('checked','checked');  //注意，这里用attr可能没有效果
                            if(g_obj_user.emailValid == 0){
                                $('#hint_user_emailValid').show();
                            }
                            else{
                                $('#user_email').attr("readonly", "readonly");
                                $('#hint_user_emailValid').hide();
                            }

                            g_obj_user.read_flag = 1;
                        }
                        else if(obj.stat == "fail"){
                            var hint = obj.reason;
                            $('#myAlertContent').html(hint);
                            $('#myAlert').modal('show');
                        }
                    });
            }
            else if(g_obj_user.read_flag == 1){
                $('#user_nickname').val(g_obj_user.nickname);
                $('#user_email').val(g_obj_user.email);
                $('#user_sign').val(g_obj_user.sign);
                $('#user_gender_'+g_obj_user.gender).prop('checked','checked');  //注意，这里用attr可能没有效果
                $('#hint_user_nickname').hide();
                $('#hint_user_email').hide();
            }
            //no else
        },
        init_contacts:function(){
            if(g_obj_contacts.cur_status == 'nothing'){
                $('#id_contacts_friend').hide();
                $('#id_contacts_stranger').hide();
                $('#id_contacts_blacklist').hide();
                $('#id_contacts_friend tbody').empty();
                $('#id_contacts_stranger tbody').empty();
                $('#id_contacts_blacklist tbody').empty();
                $('#id_contacts_friend_null').hide();
                $('#id_contacts_stranger_null').hide();
                $('#id_contacts_blacklist_null').hide();
                $('#id_button_friend').removeClass("btn-primary").addClass("btn-default");
                $('#id_button_stranger').removeClass("btn-primary").addClass("btn-default");
                $('#id_button_blacklist').removeClass("btn-primary").addClass("btn-default");

                $('#id_contacts_waiting').show();

                $.post("/home/readContacts", 
                    { user_name: g_user_name},
                    function(data){     
                        $('#id_contacts_waiting').hide();

                        // alert(data);    //约定格式....

                        var obj = JSON.parse(data);
                        if(obj.stat == "success"){      //第一次点击，切到‘我的好友’
                            vue_contacts.count_friend = obj.count_friend;
                            vue_contacts.count_friend_alive = obj.count_friend_alive;
                            vue_contacts.count_stranger = obj.count_stranger;
                            vue_contacts.count_stranger_alive = obj.count_stranger_alive;
                            vue_contacts.count_blacklist = obj.count_blacklist;

                            //在此构建表格的初始状态
                            //后续再将表格排序，优先按在线状态排序
                            if(vue_contacts.count_friend){
                                for(var i=0;i<obj.count_friend;i++){
                                    contact_add_row(obj.friend[i], 0);

                                    index = obj.friend[i].name;
                                    g_arry_contacts[index] = new Object();
                                    g_arry_contacts[index].relation = 0;
                                    g_arry_contacts[index].name = obj.friend[i].name;
                                    g_arry_contacts[index].status = obj.friend[i].status;
                                    g_arry_contacts[index].nickname = obj.friend[i].nickname;
                                    // g_arry_contacts[index].remark = obj.friend[i].remark;
                                    g_arry_contacts[index].gender = obj.friend[i].gender;
                                    g_arry_contacts[index].email = obj.friend[i].email;
                                    g_arry_contacts[index].sign = obj.friend[i].sign;
                                }
                            }

                            if(vue_contacts.count_stranger){
                                for(var i=0;i<obj.count_stranger;i++){
                                    contact_add_row(obj.stranger[i], 1);

                                    index = obj.stranger[i].name;
                                    g_arry_contacts[index] = new Object();
                                    g_arry_contacts[index].name = obj.stranger[i].name;
                                    g_arry_contacts[index].relation = 1;
                                    g_arry_contacts[index].status = obj.stranger[i].status;
                                    g_arry_contacts[index].nickname = obj.stranger[i].nickname;
                                    // g_arry_contacts[index].remark = obj.stranger[i].remark;
                                    g_arry_contacts[index].gender = obj.stranger[i].gender;
                                }
                            }

                            if(vue_contacts.count_blacklist){
                                for(var i=0;i<obj.count_blacklist;i++){
                                    contact_add_row(obj.blacklist[i], 2);

                                    index = obj.blacklist[i].name;
                                    g_arry_contacts[index] = new Object();
                                    g_arry_contacts[index].name = obj.blacklist[i].name;
                                    g_arry_contacts[index].relation = 2;
                                }
                            }

                            g_obj_contacts.cur_status = "ready";
                            vue_contacts.contacts_switch('friend');
                            g_obj_contacts.cur_status = "friend";
                            
                        }
                        else if(obj.stat == "fail"){
                            var hint = obj.reason;
                            $('#myAlertContent').html(hint);
                            $('#myAlert').modal('show');
                        }
                    });
            }
            else{ 

            }
        }
    },
})

var vue_contacts = new Vue({
    delimiters:['[[', ']]'],
    el: '#contacts',
    data: {
        count_friend: 0,
        count_friend_alive: 0,
        count_stranger: 0,
        count_stranger_alive: 0,
        count_blacklist: 0,
        chat_object: ''
    },
    methods:{
        contacts_switch:function(flag){         //联系人界面切换
            if(g_obj_contacts.cur_status == 'nothing' || g_obj_contacts.cur_status == flag)
                return;

            if(g_obj_contacts.cur_status != "ready"){
                $('#id_button_' + g_obj_contacts.cur_status).removeClass("btn-primary").addClass("btn-default");
                $('#id_contacts_' + g_obj_contacts.cur_status).hide();
                $('#id_contacts_' + g_obj_contacts.cur_status + '_null').hide();
            }

            $('#id_button_' + flag).removeClass("btn-default").addClass("btn-primary");

            if(flag == "friend"){
                if(vue_contacts.count_friend)
                    $('#id_contacts_friend').show();
                else
                    $('#id_contacts_friend_null').show();
            }
            else if(flag == "stranger"){
                if(vue_contacts.count_stranger)
                    $('#id_contacts_stranger').show();
                else
                    $('#id_contacts_stranger_null').show();
            }
            else if(flag == 'blacklist'){
                if(vue_contacts.count_blacklist)
                    $('#id_contacts_blacklist').show();
                else
                    $('#id_contacts_blacklist_null').show();
            }

            g_obj_contacts.cur_status = flag;
        },
        search_user:function(){                 //搜索用户
            gender = $('#search_gender').val();
            type = $('#search_type').val();
            content = $('#search_content').val();
            //暂时只对content做空的判断，不作其他判断
            if(content == ""){
                $('#search_content').focus();
                return;
            }
            // alert(gender);alert(type);alert(content);

            $('#id_contacts_search tbody').empty();             //搜索前先清空表格
            $.post("/home/searchContacts", 
                {
                    user_name: g_user_name,
                    type: type,
                    gender: gender,
                    content: content,
                },
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);

                    if(obj.stat == 'success'){
                        if(obj.count){
                            for(var i=0;i<obj.count;i++){
                                var tr = $("<tr></tr>");
                                tr.append('<td class="name">'+obj.contacts[i].name+'</td>');
                                tr.append('<td>'+obj.contacts[i].nickname+'</td>');
                                var gender_num = obj.contacts[i].gender;
                                var gender_str = "";
                                if(gender_num == 1)
                                    gender_str = "男";
                                else if(gender_num == 2)
                                    gender_str = "女";
                                else if(gender_num == 3)
                                    gender_str = "保密";
                                tr.append('<td>'+ gender_str +'</td>');

                                if((typeof g_arry_contacts[obj.contacts[i].name] !="undefined") && (g_arry_contacts[obj.contacts[i].name].relation == 0))
                                    tr.append('<td>已是好友</td>');
                                else if((typeof g_arry_contacts[obj.contacts[i].name] !="undefined") && (g_arry_contacts[obj.contacts[i].name].relation == 2))
                                    tr.append('<td>黑名单</td>');
                                else{
                                    var btn = "<button onclick='addFriend_bySearch(event)' type='button' class='btn btn-primary'>发送请求</button>"
                                    tr.append('<td class="handle">'+ btn + '</td>');
                                }
                                $('#id_contacts_search tbody').append(tr);
                            }

                            $('#id_contacts_search_null').hide();
                            $('#id_contacts_search').show();
                        }
                        else{   //显示提示符
                            $('#id_contacts_search_null').show();
                            $('#id_contacts_search').hide();
                        }
                    }

                });
        },
        show_news:function(event){
            obj = event.currentTarget;
            // alert($(obj).html());
            $(obj).html("读取中");
            g_obj_will = obj;
            $.post('readNewsByClasstype0',
                {
                    user_name: g_user_name,
                },
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);

                    if(obj.stat == 'success'){
                        $(g_obj_will).html("消 息");
                        if(obj.count){
                            $('#contacts_news_table tbody').empty();             //搜索前先清空表格
                            for(var i=0;i<obj.count;i++){
                                var tr = $("<tr id='"+ obj.news[i].id +"'></tr>");
                                tr.append('<td class="name">'+obj.news[i].username+'</td>');
                                var action = obj.news[i].action;
                                switch(action)
                                {
                                    case 0:action_str = "请求添加好友";
                                        break;
                                    case 1:action_str = "接收你的好友请求";
                                        break;
                                    case 2:action_str = "拒绝你的好友请求";
                                        break;
                                    case 3:action_str = "已成为你的好友";
                                        break;
                                    case 4:action_str = "将你设为黑名单";
                                        break;
                                    case 5:action_str = "想与你和解";
                                        break;
                                    case 6:action_str = "接受你的和解";
                                        break;
                                    case 7:action_str = "拒绝你的和解";
                                        break;
                                    default:
                                        break;

                                }
                                tr.append('<td class="action" action="'+ action + '">'+action_str+'</td>');
                                tr.append('<td>' + obj.news[i].time + '</td>');
                                var status = obj.news[i].status;
                                switch(status)
                                {
                                    case 0: status_str = "新消息";
                                        if(g_obj_contacts.cur_status != 'nothing'){
                                            if(action == 1 || action == 3 || action == 4 || action == 6)
                                                g_obj_contacts.cur_status = 'nothing';  //重新刷新联系人表格
                                        }
                                        break;
                                    case 1: status_str = "已读";
                                        break;
                                    case 2: status_str = "同意";
                                        break;
                                    case 3: status_str = "拒绝";
                                        break;
                                    default: break;
                                }
                                tr.append('<td class="status">'+status_str+'</td>');
                                var btn = "<button onclick='handle_news(event, \"delete\")' type='button' handle='delete' class='delete btn btn-primary'>删除</button>"
                                action = obj.news[i].action;
                                switch(action)
                                {
                                    case 0:
                                    case 5:
                                        if(status == 0 || status == 1){     //未操作的情况下
                                            btn += " <button onclick='handle_news(event, \"agree\")' type='button' handle='agree' class='response btn btn-primary'>同意</button>"
                                            btn += " <button onclick='handle_news(event, \"reject\")' type='button' handle='reject' class='response btn btn-primary'>拒绝</button>"                                        
                                        }
                                        break;
                                    default:break;  //其他的为通知型的消息
                                }
                                tr.append('<td class="handle">'+ btn + '</td>');
                                $('#contacts_news_table tbody').append(tr);
                            }

                            $('#contacts_news_hint').hide();
                            $('#contacts_news_table').show();
                        }
                        else{
                            $('#contacts_news_hint').show();
                            $('#contacts_news_table').hide();
                        }
                        
                        g_news.new_contacts -= g_news.new_contacts_base;
                        g_news.new_contacts_base = 0;       //新消息都变为旧消息
                        refresh_news_badge();
                        $('#contacts_news').modal('show');
                    }
                    else{

                    }
                });
        },
        show_addFriends:function(){
            $('#id_contacts_search_null').hide();
            $('#id_contacts_search').hide();
            $('#add_friends').modal('show');
        },
        show_statusSet:function(){
            if(g_obj_user.status == 1)
                $('#status_online').prop("checked", "checked");
            else
                $('#status_leave').prop("checked", "checked");
            $('#contacts_setting_status').modal('show');
        },
        show_permitSet:function(){
            if(g_obj_user.permitAdd == 1)
                $('#permitAdd_cond').prop("checked", "checked");
            else
                $('#permitAdd_uncond').prop("checked", "checked");

            if(g_obj_user.permitSearch == 1)
                $('#permitSearch').prop('checked', 'checked');
            else
                $('#permitSearch').prop('checked', false);

            $('#contacts_setting_permit').modal('show');
        },
        chatClear:function(){
            $.post("chatClear", 
                {
                    host: g_user_name,
                    guest: g_chat.current_guest,
                },
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);
                    if(obj.stat == 'success')
                    {
                        $('#chatDisplay').html("");     //清空
                        g_chat.new_chat_flag = 0;
                        g_chat.timestamp_1_day = '';
                        g_chat.timestamp_1_sec = -3600;
                        g_chat.timestamp_2_sec = -3600;
                    }
                    else{
                        alert("something error@chatClear back");
                    }
                });
        },
        chatSend:function(){
            var message = $('#chatSend').val();
            if(message == ""){
                $('#chatSend').focus();
                return;
            }

            $.post("chatSend", 
                {
                    host: g_user_name,
                    guest: g_chat.current_guest,
                    message: message,
                    type: 0     //0表示普通消息，1表示自动消息
                },
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);
                    if(obj.stat == 'success')
                    {
                        var msg_new = $('#chatSend').val();
                        $('#chatSend').val("");     //清空编辑框

                        var msg_old = "";
                        var time_tmp = '';
                        var day_tmp = '';
                        var sec_tmp = 0;
                        if(g_chat.new_chat_flag == 0){
                            g_chat.new_chat_flag = 1;
                            msg_old += "<div style='text-align:center'><span style='color: deeppink'>* 新消息 *</span></div>";
                        }
                        time_tmp = obj.chat_time;
                        var arry = time_tmp.split(" ");
                        day_tmp = arry[0];      //年-月-日
                        var arry_2 = arry[1].split(":");
                        sec_tmp = arry_2[0]*3600 + arry_2[1]*60 + arry_2[2];    //当天秒数
                        if(day_tmp != g_chat.timestamp_1_day || ((sec_tmp-g_chat.timestamp_1_sec) > 60*5)
                            || ((sec_tmp-g_chat.timestamp_2_sec) > (60*2)) ){
                            //不在同一天，或者消息比显示了时间的消息多了5分钟，或者比上一条消息多了2分钟
                            g_chat.timestamp_1_day = day_tmp;
                            g_chat.timestamp_1_sec = sec_tmp;
                            g_chat.timestamp_2_sec = sec_tmp;
                            msg_old += "<div style='text-align:center'><span style='color: deeppink'>* "+ time_tmp +" *</span></div>";
                        }
                        else{
                            g_chat.timestamp_2_sec = sec_tmp;
                        }

                        msg_old += "<div><我> "+msg_new + "</div>";

                        if(obj.status_leave == 1){
                            msg_old += "<div style='text-align:right;color:blue'>【自动回复】您好，我现在有事不在，一会再和您联系！&lt;"+ g_chat.current_guest +"&gt;</div>";
                        }

                        $('#chatDisplay').append(msg_old);
                    }
                    else{
                        if(obj.reason == "CHAT_TOO_OFTEN"){
                            var msg_old = "<div>【您发送太快了！请稍后再试...】</div>";
                            $('#chatDisplay').append(msg_old);
                        }
                        else if(obj.reason == "CHAT_TOO_MUCH"){
                            var remain = obj.remain;
                            var msg_old = "<div>【您在过去10分钟发送消息数量有点多！请等候" + remain + "秒再发...】</div>";
                            $('#chatDisplay').append(msg_old);
                        }
                        else
                            alert("something error@chatSend back");
                    }
                    $('#chatDisplay').append("<input type='button' value='***' />");
                    $('#chatDisplay').find('input:last-child').focus().remove();

                    $('#chatSend').focus();
                });
        },
        setting_status:function(){          //状态改变
            items = new Object();
            tmp = $("input:radio[name='statusRadios']:checked").val();
            if(tmp == 'online')
                items.setting_status = 1;
            else    //leave
                items.setting_status = 2;

            g_obj_user.status_will = items.setting_status
            $.post("setting", 
            {
                user_name: g_user_name,
                items: JSON.stringify(items)
            },
            function(data){
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == 'success')
                {
                    g_obj_user.status = g_obj_user.status_will
                    $('#contacts_setting_status').modal('hide');
                }
                else{
                    alert("something error@setting back");
                }
            });
        },
        setting_permit:function(){          //权限设置
            items = new Object();
            tmp = $('input:checkbox[name="permitCheckbox"]').prop('checked');
            if(tmp)     //true
                items.setting_permitSearch = 1;
            else    //false
                items.setting_permitSearch = 0;

            tmp = $("input:radio[name='permitRadios']:checked").val();
            if(tmp == 'cond')
                items.setting_permitAdd = 1;
            else    //uncond
                items.setting_permitAdd = 0;

            // alert(JSON.stringify(items))

            g_obj_user.permitAdd_will = items.setting_permitAdd;
            g_obj_user.permitSearch_will = items.setting_permitSearch;

            $.post("setting", 
            {
                user_name: g_user_name,
                items: JSON.stringify(items)
            },
            function(data){
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == 'success')
                {
                    g_obj_user.permitAdd = g_obj_user.permitAdd_will
                    g_obj_user.permitSearch = g_obj_user.permitSearch_will
                    $('#contacts_setting_permit').modal('hide');

                }
                else{
                    alert("something error@setting back");
                }

            });
        }

    }
})

var vue_vote = new Vue({
    delimiters:['[[', ']]'],
    el: '#vote',
    data: {
        hint_vote_invite: '请输入投票邀请码',
        hint_vote_point: '另外发表自己的意见和建议，限50字',
        vote_cnt: 0,
        vote_mx_1_A: 0,vote_mx_1_B: 0,vote_mx_1_C: 0,
        vote_mx_2_A: 0,vote_mx_2_B: 0,vote_mx_2_C: 0,
        vote_mx_3_A: 0,vote_mx_3_B: 0,vote_mx_3_C: 0,
        vote_mx_4_A: 0, vote_mx_4_B: 0,vote_mx_4_C: 0,
        vote_mx_5_A: 0,vote_mx_5_B: 0,vote_mx_5_C: 0,
        vote_mx_6_A: 0,vote_mx_6_B: 0,vote_mx_6_C: 0,
        vote_mx_7_A: 0,vote_mx_7_B: 0,vote_mx_7_C: 0,
        vote_mx_8_A: 0,vote_mx_8_B: 0,vote_mx_8_C: 0,
        vote_mx_9_A: 0,vote_mx_9_B: 0,vote_mx_9_C: 0,
        vote_mx_10_A: 0,vote_mx_10_B: 0,vote_mx_10_C: 0,

        vote_yz_1_A: 0,vote_yz_1_B: 0,vote_yz_1_C: 0,
        vote_yz_2_A: 0,vote_yz_2_B: 0,vote_yz_2_C: 0,
        vote_yz_3_A: 0,vote_yz_3_B: 0,vote_yz_3_C: 0,
        vote_yz_4_A: 0, vote_yz_4_B: 0,vote_yz_4_C: 0,
        vote_yz_5_A: 0,vote_yz_5_B: 0,vote_yz_5_C: 0,
        vote_yz_6_A: 0,vote_yz_6_B: 0,vote_yz_6_C: 0,
        vote_yz_7_A: 0,vote_yz_7_B: 0,vote_yz_7_C: 0,
        vote_yz_8_A: 0,vote_yz_8_B: 0,vote_yz_8_C: 0,
        vote_yz_9_A: 0,vote_yz_9_B: 0,vote_yz_9_C: 0,
        vote_yz_10_A: 0,vote_yz_10_B: 0,vote_yz_10_C: 0,
    },
    methods:{
        read_vote:function(id, mode){
            //读取用户投票信息

            if(id == g_vote.id && mode == 'manual')
                return;
            g_vote.id = id;
            $('.btn_vote').removeClass("btn-warning").addClass("btn-info");
            $('#btn_vote_'+id).removeClass("btn-info").addClass("btn-warning");

            $('#vote_invite_div').hide();
            $('#vote_invite_warning').hide();
            $('#vote_mx').hide();
            $('#vote_yz').hide();
            $('#vote_cnt').hide();
            $('.vote_info').hide();

            $.post("read_vote", 
                {id: id},
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);
                    if(obj.join == 'NO'){
                        $('#vote_invite_div').show();
                    }
                    else{   //YES
                        if(obj.id == 1){
                            // alert(obj.act);
                            statistics_obj = JSON.parse(obj.statistics);
                            vue_vote.vote_cnt = statistics_obj.cnt;
                            $('#vote_cnt').show();

                            for(var i=0;i<statistics_obj.info.length;i++){
                                vue_vote['vote_mx_'+ (i+1) +'_A'] = '('+ statistics_obj.info[i].A +')';
                                vue_vote['vote_mx_'+ (i+1) +'_B'] = '('+ statistics_obj.info[i].B +')';
                                vue_vote['vote_mx_'+ (i+1) +'_C'] = '('+ statistics_obj.info[i].C +')';
                            }
                            $('.vote_info').show();
                            
                            act_obj = JSON.parse(obj.act);
                            for(var i=0;i<act_obj.length;i++){
                                $("input:radio[name='vote_mx_"+ act_obj[i].pos +"'][value='"+ act_obj[i].select +"']").prop("checked", "checked");
                            }

                            $('#vote_point_mx').val(obj.point);

                            $('#vote_mx').find("input").attr("disabled", "disabled");   //已经投过票就不能在投咯
                            $('#vote_mx_commit_div').hide();        //隐藏提交按钮
                            $('#vote_mx').show();
                        }
                        else if(obj.id == 2){
                            statistics_obj = JSON.parse(obj.statistics);
                            vue_vote.vote_cnt = statistics_obj.cnt;
                            $('#vote_cnt').show();

                            for(var i=0;i<statistics_obj.info.length;i++){
                                vue_vote['vote_yz_'+ (i+1) +'_A'] = '('+ statistics_obj.info[i].A +')';
                                vue_vote['vote_yz_'+ (i+1) +'_B'] = '('+ statistics_obj.info[i].B +')';
                                vue_vote['vote_yz_'+ (i+1) +'_C'] = '('+ statistics_obj.info[i].C +')';
                            }
                            $('.vote_info').show();

                            act_obj = JSON.parse(obj.act);
                            for(var i=0;i<act_obj.length;i++){
                                $("input:radio[name='vote_yz_"+ act_obj[i].pos +"'][value='"+ act_obj[i].select +"']").prop("checked", "checked");
                            }

                            $('#vote_point_yz').val(obj.point);

                            $('#vote_yz').find("input").attr("disabled", "disabled");
                            $('#vote_yz_commit_div').hide();    
                            $('#vote_yz').show();
                        }

                    }
            });
        },
        vote_invite_check:function(){
            // 发送投票邀请码
            invite = $('#vote_invite').val()
            if(invite == ""){
                $('#vote_invite').focus();
                return;
            }
                
            $.post("vote_invite_check", 
                {
                    id: g_vote.id,
                    invite: invite,
                },
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);
                    if(obj.check == 'OK'){
                        $('#vote_invite_warning').hide();
                        $('#vote_invite_div').hide();
                        //显示投票题目
                        if(obj.id == 1){
                            $('#vote_mx_commit_div').show();
                            $('#vote_mx').show();
                        }
                        else if(obj.id == 2){
                            $('#vote_yz_commit_div').show();
                            $('#vote_yz').show();
                        }
                    }
                    else{
                        $('#vote_invite_warning').show();
                    }
            });

        },
        commit_vote:function(id){
            //提交用户投票选择
            var act = new Array();
            var point = "";

            if(id == 1){
                for(var i=1;i<=10;i++){
                    tmp = $("input:radio[name='vote_mx_"+i+ "']:checked").val();
                    act[i-1] = new Object();
                    act[i-1].pos = i;
                    act[i-1].select = tmp;
                }

                point = $('#vote_point_mx').val();
                if(point == "") point = "NULL";
            }
            else if(id == 2){
                for(var i=1;i<=10;i++){
                    tmp = $("input:radio[name='vote_yz_"+i+ "']:checked").val();
                    act[i-1] = new Object();
                    act[i-1].pos = i;
                    act[i-1].select = tmp;
                }

                point = $('#vote_point_yz').val();
                if(point == "") point = "NULL";
            }
            else
            {}  //nothing

            // alert(JSON.stringify(act));

            $.post("commit_vote", 
                {
                    id: id,
                    act: JSON.stringify(act),
                    point: point,
                },
                function(data){
                    // alert(data);    //约定格式....
                    var obj = JSON.parse(data);
                    if(obj.stat == "success"){
                        vue_vote.read_vote(obj.id, 'auto');
                    }
                    else
                        alert("something error@commit_vote");
            });
        },
    },
})

var vue_modify_password = new Vue({
  delimiters:['[[', ']]'],
  el: '#modify_password',
  data: {
    hint_user_old_password: "",
    hint_user_old_password_default: "请输入原密码！",

    hint_user_new_password: "",
    hint_user_new_password_default: "包含英文字符、数字、下划线，6~16个字符",

    hint_user_new_password2:"",
    hint_user_new_password2_default: "包含英文字符、数字、下划线，6~16个字符",
  },
  methods:{
      check_input:function(event){
          obj = event.currentTarget;

          if(obj.id == "user_old_password"){
              var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
              if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_old_password = this.hint_user_old_password_default;
                    else
                        this.hint_user_old_password = "包含英文字符、数字、下划线，6~16个字符！";
                    $('#hint_user_old_password').show(); 
              }
              else{
                  $('#hint_user_old_password').hide();
              }
          }
          else if(obj.id == "user_new_password"){
              var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
              if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_new_password = "请输入新密码！";
                    else
                        this.hint_user_new_password = this.hint_user_new_password_default;
                    $('#hint_user_new_password').show(); 
              }
              else{
                  $('#hint_user_new_password').hide();
              }
          }
          else if(obj.id == "user_new_password2"){
              var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
              if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_new_password2 = "请确认密码！";
                    else
                        this.hint_user_new_password2 = this.hint_user_new_password2_default;
                    $('#hint_user_new_password2').show(); 
              }
              else{
                  $('#hint_user_new_password2').hide();
              }
          }
          else{

          }
      },

      check_items: function(form){
            var obj = form.user_old_password;
            var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
            if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_old_password = this.hint_user_old_password_default;
                else
                    this.hint_user_old_password = "包含英文字符、数字、下划线，6~16个字符！";
                $('#hint_user_old_password').show(); 
                obj.focus();return;
            }
            var user_old_password = obj.value;

            var obj = form.user_new_password;
            var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
            if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_new_password = "请输入新密码！";
                else
                    this.hint_user_new_password = this.hint_user_new_password_default;
                $('#hint_user_new_password').show(); 
                obj.focus();return;
            }

            var obj = form.user_new_password2;
            var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
            if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_new_password2 = "请确认密码！";
                else
                    this.hint_user_new_password2 = this.hint_user_new_password2_default;
                $('#hint_user_new_password2').show(); 
                obj.focus();return;
            }

            if(form.user_new_password.value != form.user_new_password2.value){
                this.hint_user_new_password2 = "'密码确认'与'新密码'不一致！";
                $('#hint_user_new_password2').show(); 
                form.user_new_password2.focus();return;
            }

            if(form.user_new_password.value == form.user_old_password.value){
                this.hint_user_new_password = "'新密码'与'原密码'一致！";
                $('#hint_user_new_password').show(); 
                form.user_new_password.focus();return;
            }
            var user_new_password = form.user_new_password.value;

            $.post("/home/modifyPassword", 
                { user_name: g_user_name,
                  user_old_password : user_old_password,
                  user_new_password : user_new_password,
                },
                function(data){     //后续data需要改成json格式
                    // alert(data);    //约定格式
                    var obj = JSON.parse(data);
                    if(obj.stat == "success")
                        ret_login = 1;
                    else
                        ret_login = 0;

                    hint = obj.hint;
                    $('#myAlertContent').html(hint);
                    $('#myAlert').modal('show');
                });
      }

  }
}); //end: var vm = new Vue({.......modify_password

var vue_modify_base = new Vue({
  delimiters:['[[', ']]'],
  el: '#modify_base',
  data: {
    hint_user_nickname: "",
    hint_user_nickname_default: "包含英文字符、符号、数字、中文，3~8个字或字符",

    hint_user_email: "",
    hint_user_email_default: "用于找回密码等业务",

  },
  methods:{
      check_input:function(event){
          obj = event.currentTarget;

          if(obj.id == "user_nickname"){
              var pattern = /[\u4e00-\u9fa5_a-zA-Z0-9_]/g;
              if(obj.value == '' || obj.value.length < 3 || obj.value.length > 8 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_nickname = "请输入昵称！";
                    else
                        this.hint_user_nickname = this.hint_user_nickname_default;
                    $('#hint_user_nickname').show(); 
                    // obj.focus();
              }
              else{
                  $('#hint_user_nickname').hide();
              }
          }
          else if(obj.id == "user_email"){
              var pattern = /^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/g;

              if(obj.value == '' || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_email = "请输入Email！";
                    else
                        this.hint_user_email = "邮箱格式不正确！";
                    $('#hint_user_email').show(); 
              }
              else{
                  $('#hint_user_email').hide();
              } 
          }
          else{

          }
      },

      check_items: function(form){
            var obj = form.user_nickname;
            var pattern = /[\u4e00-\u9fa5_a-zA-Z0-9_]/g;
            if(obj.value == '' || obj.value.length < 3 || obj.value.length > 8 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_nickname = "请输入昵称！";
                else
                    this.hint_user_nickname = this.hint_user_nickname_default;
                $('#hint_user_nickname').show(); 
                obj.focus();return;
            }

            var obj = form.user_email;
            var pattern = /^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/g;
            if(obj.value == '' || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_email = "请输入Email！";
                else
                    this.hint_user_email = "邮箱格式不正确！";
                $('#hint_user_email').show();
                obj.focus();return;
            }

            $.post("/home/modifyBase", 
                { user_name: g_user_name,
                  user_nickname : form.user_nickname.value,
                  user_email : form.user_email.value,
                  user_sign : form.user_sign.value,
                  user_gender: form.user_gender.value,
                },
                function(data){     
                    // alert(data);    //约定格式
                    var obj = JSON.parse(data);
                    if(obj.stat == "success"){
                        g_obj_user.read_flag = 0;
                        g_obj_user.email = $('#user_email').val();  //最好再加个中间变量，缓冲一下
                        var hint = "资料修改成功！";
                        $('#myAlertContent').html(hint);
                        $('#myAlert').modal('show');
                    }
                    else{  //fail
                        var hint = obj.reason;
                        $('#myAlertContent').html(hint);
                        $('#myAlert').modal('show');
                    }
                });
      }

  }
});
</script>