<! DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/bootstrap-theme.min.css" rel="stylesheet">
    <script src="static/js/jquery-3.3.1.min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>

    <script src="static/js/vue.min.js"></script>
    <script type="text/javascript" src="static/js/csrf.js"></script>

    <!--<script src="static/js/home/home_modifyPassword.js"></script>无效-->
</head>

<body>
<!--登录成功后界面-->
<nav class="navbar navbar-default" role="navigation" id="navigation">
    <div class="navbar-header">
        <a class="navbar-brand" href="#"><i style="font-size:30px;color:deeppink">MyQ</i> {{user.name}}</a>
    </div>
    <div>
        <ul class="nav navbar-nav">
            <li class="active"><a href="#hall" data-toggle="tab">
                {% if user.hall.new > 0 %}
                <span style="background-color:orange" class="badge pull-right">{{user.hall.new}}</span>
                {% endif %}
                大厅&nbsp;</a></li>
            <li><a href="#email" data-toggle="tab">
                {% if user.email.new > 0 %}
                <span style="background-color:orange" class="badge pull-right">{{user.email.new}}</span>
                {% endif %}
                信息&nbsp;</a></li>
            <li><a href="#bottle" data-toggle="tab">
                {% if user.bottle.new > 0 %}
                <span style="background-color:orange" class="badge pull-right">{{user.bottle.new}}</span>
                {% endif %}
                漂流瓶&nbsp;</a></li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">我的<b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a @click="init_base()" href="#modify_base" data-toggle="tab">修改资料</a></li>
                    <li><a href="#modify_password" data-toggle="tab">修改密码</a></li>
                    <li class="divider"></li>
                    <li><a href="logout">退 出</a></li>
                </ul>
            </li>
        </ul>
    </div>
</nav>
<!--上面为导航栏，下面为内容-->
<div class="tab-content">
    <div class="tab-pane fade in active" id="hall">
        <p>Hall</p>
    </div>
    <div class="tab-pane fade" id="email">
        <p>email</p>
    </div>
    <div class="tab-pane fade" id="bottle">
        <p>bottle</p>
    </div>
    <div class="tab-pane fade" id="modify_base">
        {% include 'home_modifyBase.html' %}
    </div>
    <div class="tab-pane fade" id="modify_password">
        {% include 'home_modifyPassword.html' %}
    </div>
</div>

<!-- 模态框（Modal） 信息提示警告框-->
<div class="modal fade" id="myAlert" tabindex="-1" role="dialog" aria-labelledby="myAlertLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myAlertLabel">信息</h4>
            </div>
            <div class="modal-body" id="myAlertContent"></div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

</body>
</html>


<script type="text/javascript">

function emailVerify_recv()
{
    if($('#myEmailVerifyInput').val() == ""){
        $('#myEmailVerifyInput').focus();
    }
    else{
        $.post("/home/emailVerify_recv", 
            { 
                user_name: g_user_name,
                verify_code: $('#myEmailVerifyInput').val(),
            },
            function(data){     
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == "success"){
                    var hint = "邮箱绑定验证成功，请重新登录！";
                    $('#myEmailVerifyContent').html(hint);
                    ret_login = 1;
                }
                else if(obj.stat == "fail"){
                    var hint = obj.hint;
                    $('#myEmailVerifyContent').html(hint);
                }
            });
    }
}

$(function () { 
    $('#myEmailVerify').on('show.bs.modal', function () {
        var hint = "请稍后，正在发送邮件...";
        $('#myEmailVerifyContent').html(hint);

        $.post("/home/emailVerify_send", 
            { user_name: g_user_name},
            function(data){     
                // alert(data);    //约定格式....
                var obj = JSON.parse(data);
                if(obj.stat == "success"){
                    var hint = "已往您的邮箱"+ g_user_email +"发送验证码，请登陆邮箱查看，并在此：" + 
                        "<input type='text' class='form-control' id='myEmailVerifyInput' placeholder='输入验证码'></input><br />" +
                        "<button type='button' onclick='emailVerify_recv()' class='btn btn-primary btn-block'>确 定</button>";

                    $('#myEmailVerifyContent').html(hint);
                }
                else if(obj.stat == "fail"){
                    var hint = obj.hint;
                    $('#myEmailVerifyContent').html(hint);
                }
            });
    })


    $('#myAlert').on('hidden.bs.modal', function () {
        if(ret_login == 1){     //密码修改成功，跳转到登陆页面
            window.location.href = "login";
        }
    })
    $('#myEmailVerify').on('hidden.bs.modal', function () {
        if(ret_login == 1){     //跳转到登陆页面
            window.location.href = "login";
        }
    })
});

var g_user_name = '{{user.name}}';      //记得加引号哦
var g_init_user = 0;                //初始化标志
var g_user_nickname = "";
var g_user_email = "";
var g_user_emailValid = 0;
var g_user_sign = 0;
var g_user_gender = 0;

var ret_login = 0;

var vue_nav = new Vue({
    delimiters:['[[', ']]'],
    el: '#navigation',
    data: {
    },
    methods:{
        init_base:function(){
            if(g_init_user == 0){
                $.post("/home/readBase", 
                    { user_name: g_user_name},
                    function(data){     
                        // alert(data);    //约定格式....
                        var obj = JSON.parse(data);
                        if(obj.stat == "success"){
                            g_user_nickname = obj.user_nickname;
                            g_user_email = obj.user_email;
                            g_user_sign = obj.user_sign;
                            g_user_gender = obj.user_gender;
                            g_user_emailValid = obj.user_emailValid;
                            
                            $('#user_nickname').val(g_user_nickname);
                            $('#user_email').val(g_user_email);
                            $('#user_sign').val(g_user_sign);
                            $('#user_gender_'+g_user_gender).prop('checked','checked');  //注意，这里用attr可能没有效果
                            if(g_user_emailValid == 0){
                                $('#hint_user_emailValid').show();
                            }
                            else{
                                $('#user_email').attr("readonly", "readonly");
                                $('#hint_user_emailValid').hide();
                            }

                            g_init_user = 1;
                        }
                        else if(obj.stat == "fail"){
                            var hint = obj.reason;
                            $('#myAlertContent').html(hint);
                            $('#myAlert').modal('show');
                        }
                    });
            }
            else if(g_init_user == 1){
                $('#user_nickname').val(g_user_nickname);
                $('#user_email').val(g_user_email);
                $('#user_sign').val(g_user_sign);
                $('#user_gender_'+g_user_gender).prop('checked','checked');  //注意，这里用attr可能没有效果
                $('#hint_user_nickname').hide();
                $('#hint_user_email').hide();
            }
            //no else
        }
    },
})

var vue_modify_password = new Vue({
  delimiters:['[[', ']]'],
  el: '#modify_password',
  data: {
    hint_user_old_password: "",
    hint_user_old_password_default: "请输入原密码！",

    hint_user_new_password: "",
    hint_user_new_password_default: "包含英文字符、数字、下划线，6~16个字符",

    hint_user_new_password2:"",
    hint_user_new_password2_default: "包含英文字符、数字、下划线，6~16个字符",
  },
  methods:{
      check_input:function(event){
          obj = event.currentTarget;

          if(obj.id == "user_old_password"){
              var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
              if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_old_password = this.hint_user_old_password_default;
                    else
                        this.hint_user_old_password = "包含英文字符、数字、下划线，6~16个字符！";
                    $('#hint_user_old_password').show(); 
              }
              else{
                  $('#hint_user_old_password').hide();
              }
          }
          else if(obj.id == "user_new_password"){
              var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
              if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_new_password = "请输入新密码！";
                    else
                        this.hint_user_new_password = this.hint_user_new_password_default;
                    $('#hint_user_new_password').show(); 
              }
              else{
                  $('#hint_user_new_password').hide();
              }
          }
          else if(obj.id == "user_new_password2"){
              var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
              if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_new_password2 = "请确认密码！";
                    else
                        this.hint_user_new_password2 = this.hint_user_new_password2_default;
                    $('#hint_user_new_password2').show(); 
              }
              else{
                  $('#hint_user_new_password2').hide();
              }
          }
          else{

          }
      },

      check_items: function(form){
            var obj = form.user_old_password;
            var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
            if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_old_password = this.hint_user_old_password_default;
                else
                    this.hint_user_old_password = "包含英文字符、数字、下划线，6~16个字符！";
                $('#hint_user_old_password').show(); 
                obj.focus();return;
            }
            var user_old_password = obj.value;

            var obj = form.user_new_password;
            var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
            if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_new_password = "请输入新密码！";
                else
                    this.hint_user_new_password = this.hint_user_new_password_default;
                $('#hint_user_new_password').show(); 
                obj.focus();return;
            }

            var obj = form.user_new_password2;
            var pattern = /^([a-zA-z_0-9]{1})([\w]*)$/g;
            if(obj.value == '' || obj.value.length < 6 || obj.value.length > 16 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_new_password2 = "请确认密码！";
                else
                    this.hint_user_new_password2 = this.hint_user_new_password2_default;
                $('#hint_user_new_password2').show(); 
                obj.focus();return;
            }

            if(form.user_new_password.value != form.user_new_password2.value){
                this.hint_user_new_password2 = "'密码确认'与'新密码'不一致！";
                $('#hint_user_new_password2').show(); 
                form.user_new_password2.focus();return;
            }

            if(form.user_new_password.value == form.user_old_password.value){
                this.hint_user_new_password = "'新密码'与'原密码'一致！";
                $('#hint_user_new_password').show(); 
                form.user_new_password.focus();return;
            }
            var user_new_password = form.user_new_password.value;

            $.post("/home/modifyPassword", 
                { user_name: g_user_name,
                  user_old_password : user_old_password,
                  user_new_password : user_new_password,
                },
                function(data){     //后续data需要改成json格式
                    // alert(data);    //约定格式
                    var obj = JSON.parse(data);
                    if(obj.stat == "success")
                        ret_login = 1;
                    else
                        ret_login = 0;

                    hint = obj.hint;
                    $('#myAlertContent').html(hint);
                    $('#myAlert').modal('show');
                });
      }

  }
}); //end: var vm = new Vue({.......modify_password

var vue_modify_base = new Vue({
  delimiters:['[[', ']]'],
  el: '#modify_base',
  data: {
    hint_user_nickname: "",
    hint_user_nickname_default: "包含英文字符、符号、数字、中文，3~8个字或字符",

    hint_user_email: "",
    hint_user_email_default: "用于找回密码等业务",

  },
  methods:{
      check_input:function(event){
          obj = event.currentTarget;

          if(obj.id == "user_nickname"){
              var pattern = /[\u4e00-\u9fa5_a-zA-Z0-9_]/g;
              if(obj.value == '' || obj.value.length < 3 || obj.value.length > 8 || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_nickname = "请输入昵称！";
                    else
                        this.hint_user_nickname = this.hint_user_nickname_default;
                    $('#hint_user_nickname').show(); 
                    // obj.focus();
              }
              else{
                  $('#hint_user_nickname').hide();
              }
          }
          else if(obj.id == "user_email"){
              var pattern = /^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/g;

              if(obj.value == '' || pattern.test(obj.value) != true){
                    if(obj.value == '')
                        this.hint_user_email = "请输入Email！";
                    else
                        this.hint_user_email = "邮箱格式不正确！";
                    $('#hint_user_email').show(); 
              }
              else{
                  $('#hint_user_email').hide();
              } 
          }
          else{

          }
      },

      check_items: function(form){
            var obj = form.user_nickname;
            var pattern = /[\u4e00-\u9fa5_a-zA-Z0-9_]/g;
            if(obj.value == '' || obj.value.length < 3 || obj.value.length > 8 || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_nickname = "请输入昵称！";
                else
                    this.hint_user_nickname = this.hint_user_nickname_default;
                $('#hint_user_nickname').show(); 
                obj.focus();return;
            }

            var obj = form.user_email;
            var pattern = /^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/g;
            if(obj.value == '' || pattern.test(obj.value) != true){
                if(obj.value == '')
                    this.hint_user_email = "请输入Email！";
                else
                    this.hint_user_email = "邮箱格式不正确！";
                $('#hint_user_email').show();
                obj.focus();return;
            }

            $.post("/home/modifyBase", 
                { user_name: g_user_name,
                  user_nickname : form.user_nickname.value,
                  user_email : form.user_email.value,
                  user_sign : form.user_sign.value,
                  user_gender: form.user_gender.value,
                },
                function(data){     
                    // alert(data);    //约定格式
                    var obj = JSON.parse(data);
                    if(obj.stat == "success"){
                        g_init_user = 0;
                        g_user_email = $('#user_email').val();  //最好再加个中间变量，缓冲一下
                        var hint = "资料修改成功！";
                        $('#myAlertContent').html(hint);
                        $('#myAlert').modal('show');
                    }
                    else{  //fail
                        var hint = obj.reason;
                        $('#myAlertContent').html(hint);
                        $('#myAlert').modal('show');
                    }
                });
      }

  }
});
</script>